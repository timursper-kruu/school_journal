"use strict";let jrnSbList={},jrnThList={};let jrnArr={};const jrnContLoad=async()=>{let cont;let grSbTh=dqs("#jrnSubj").value;if(!grSbTh){cont="<table id='allSb'><tr><th>Предмет,&nbsp;учитель</th>";let pers=[],perstart=[];for(let period in DTSIT){if(perstart.includes(DTSIT[period][2]))continue;perstart.push(DTSIT[period][2]);pers.push(period);cont+=`<th>${DTSIT[period][0]}</th>`}cont+="</tr>";for(let sbCode of Object.keys(jrnArr).sort((a,b)=>{let x=a.split("_")[1].slice(1),y=b.split("_")[1].slice(1);return Number(x)-Number(y)})){let sbCont=jrnArr[sbCode];let[grName,sbName,tchName]=sbCode.split("_"),gruppa=grName.includes("-")?`${grName.split("-")[1]}; `:"",subjStr=`${jrnSbList[sbName]}<br>${gruppa+jrnThList[tchName]}`;cont+=`<tr><td>${subjStr}</td>`;let grads={};for(let perCod of pers)grads[perCod]="";for(let dtCod of Object.keys(sbCont).sort()){let grArr=sbCont[dtCod];if(dtCod.length>4)continue;if(grArr[3]==undefined)continue;let otm=grArr[3].toString().replace(/^999$/,"зач")+" ";if(grArr[0].includes("Экзамен"))otm=`<b>${otm}</b>`;let perNum=whereis(dtCod);if(perNum==99)continue;let period=Object.keys(DTSIT)[perNum-1];if(grads[period]!==undefined)grads[period]+=otm}for(let perCod of pers)cont+=`<td>${grads[perCod].trim()}</td>`;cont+="</tr>"}dqs("#jrnCont").innerHTML=cont+"</table>";return}let grades=jrnArr[grSbTh]||{},wArr=["0","0.5","","1.5","2.0","2.5","3.0","3.5","4.0"];cont="<table><tr><th>Дата</th><th>Вес</th><th>Тема урока</th>"+"<th>Дом.&nbsp;задание</th><th>Отм.</th></tr>";if(!Object.keys(grades).length){dqs("#jrnCont").innerHTML="<b>Пока ничего нет.</b>";return}let dates=Object.keys(grades).sort();for(let d of dates){if(grades[d][2]>8)continue;let dt=dateConv(d),cls="",stTd="";let otm=typeof grades[d][3]!="undefined"?grades[d][3]:"";otm=otm.replace(/^999$/,"зач");if(grades[d][0].includes("Экзамен")){cls=" class='it'";stTd=" style='color:black'"}if(d.length>4){dt=DTSIT[d][0];cls=" class='it'";otm=otm.toString().replace(/^0$/,"н/а")}cont+=`<tr${cls}>`+`<td>${dt}</td><td${stTd}>${wArr[grades[d][2]]}</td>`+`<td>${grades[d][0]}</td><td>${grades[d][1]}</td>`+`<td>${otm}</td></tr>`}dqs("#jrnCont").innerHTML=cont+"</table>";let stat=`<h3>Статистика</h3><table id="jrnStat"><tr><th> </th>`+`<th>Сумма баллов<br>(с учетом весов)</th>`+`<th>Средне&shy;взвешенный<br>балл</th>`+`<th>Пропущено<br>уроков</th></tr>`;for(let itDate of Object.keys(DTSIT)){let wSum=0,sum=0,av=0,abs=0;for(let dt of Object.keys(grades)){if(dt>=DTSIT[itDate][2]&&dt<=DTSIT[itDate][3])if(grades[dt][3]){let w=grades[dt][2],gFull=grades[dt][3];let gClear=gFull.replace(/н/g,"");abs+=gFull.length-gClear.length;gClear=gClear.replace(/\s{2,}/g," ").trim();if(gClear)if(gClear!="999"){let gArr=gClear.split(" ");for(let x of gArr){sum+=Number(x)*w;wSum+=w}}}}if(wSum)av=(sum/wSum).toFixed(2);stat+=`<tr><td>${DTSIT[itDate][1]}</td><td>${sum/2}</td>`+`<td>${av}</td><td>${abs}</td></tr>`}dqs("#jrnCont").innerHTML+=stat};createSection("journal",`\n   <select id="jrnSubj" onChange="jrnContLoad();"></select>\n   <div id="jrnCont"><img src='static/preloader.gif'></div>\n`);getContent.journal=(async()=>{let apiResp=await apireq("subjList");let subjListDop=JSON.parse(apiResp);jrnSbList={...subjDef,...subjListDop};apiResp=await apireq("teachList");let teachList=JSON.parse(apiResp);for(let teach of teachList)jrnThList[teach.login]=teach.fio;info(0,"Пожалуйста, дождитесь<br>загрузки данных.");apiResp=await apireq("jrnGet",[]);info(2);if(apiResp=="none"){dqs("#jrnCont").innerHTML="<b>Дневник пока пуст.</b>";return}jrnArr=JSON.parse(apiResp);let keysArr=Object.keys(jrnArr);if(!keysArr.length){dqs("#jrnCont").innerHTML="<b>Дневник пока пуст.</b>";return}keysArr.sort((a,b)=>{let aSb=a.split("_")[1],bSb=b.split("_")[1];if(aSb.length!=bSb.length)return aSb.length<bSb.length?1:-1;else if(aSb.length==3)return aSb>bSb?1:-1;else return aSb.substr(1,3)>bSb.substr(1,3)?1:-1});let selInn="<option value=''>Текущие отметки (все предметы)</option>";for(let k of keysArr){let kArr=k.split("_"),grName=kArr[0],subj=jrnSbList[kArr[1]],teach=jrnThList[kArr[2]];teach=grName.includes("-")?`(${grName.split("-")[1]}; ${teach})`:`(${teach})`;selInn+=`<option value="${k}">${subj} ${teach}</option>`}dqs("#jrnSubj").innerHTML=selInn;dqs("#jrnSubj").style.display="block";jrnContLoad()});